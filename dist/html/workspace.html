<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Spatial shell workspace</title>
<script src="https://aframe.io/releases/1.6.0/aframe.min.js" crossorigin></script>
<script src="js/grab2.js?2"></script>
<script src="https://unpkg.com/vue@3/dist/vue.global.js" crossorigin></script>
<script src="js/ssclient.js"></script>
<script type=module>
const $ = (o)=>document.querySelector(o)
const DEBUG = true 
const eventSource = new EventSource('/events');

const objs = [] 
// サーバからのpush API　
eventSource.onmessage = async  (event) => {
		const data = JSON.parse(event.data) ;
		const pid = data.pid 
		console.log(data) ;
		switch(data.cmd) {
			case "open":
				const cinst = await APP.addobj({'path':data.path,'param':data.p})
				objs.push({'pid':pid,'inst':cinst,'data':data})
				console.log(objs) 
				break ;
			case "update":
				objs.forEach(o=>{
					if(o.pid == pid ) {
						console.log(`reload ${pid}`)
						o.inst.app.reloadComponent()
					}
				})
				break ;
			case "param":
				objs.forEach(o=>{
				if(o.pid == pid ) {
					console.log(`setparam ${pid}`)
					for(let k in data.param) {
						const v = data.param[k] 
						o.inst.app[k] = parseFloat(v)!=NaN?parseFloat(v):v
						console.log(`set ${k} to ${data.param[k]}`)
					}
				}
			})
			break ;	
				break ;
			case "kill":
				objs.forEach(o=>{
					if(o.pid == pid ) {
						console.log(`remove ${pid}`)
						$('#base').removeChild(o.inst.el) 
					}
				})
				break ;
			case "clear":
				$('#base').innerHTML = "" 
				objs.length = 0 
				break ;
		}
		
};
// scene vue app
const APP = Vue.createApp({
	created() {
	},
	data() {
		return {
			bg_kind:"passthru",
			bg_mix:1,
			posx:0,
			stat_calls:0,
			stat_poly:0
		}
	},
	methods:{
		// create new app instance
		async addobj(param) {
			console.log(param)
			const prop = {
				scale:1,
				basescale:param.param.basescale?param.param.basescale:1, 
				hcolor:"#ccc"
			}
			console.log(prop)
			const propstr = [':pscale="scale*basescale"']
			for(let k in param.param) {
//				if(prop[k]) continue 
				prop[k] = param.param[k] ;
				propstr.push(parseFloat(prop[k])!=NaN?`:${k}=${k}`:`:${k}="${k}"`)
			}
			console.log(propstr) 
			const app2 = Vue.createApp({
				data() {
					prop.key = 0
					prop.comppath = param.path
					prop.ccompo = null
					return prop
				},
				created() {
					this.loadComponent(); // コンポーネントの初期ロード
				},
				methods:{
					async loadComponent() {
						// 現在時刻をクエリパラメータとして付加し、キャッシュを防止
						const timestamp = new Date().getTime();
					
						// 動的にコンポーネントをインポートし、キャッシュを避ける
						const module = await import(`${this.comppath}?${timestamp}`);
						console.log(module.default)
						this.ccompo = module.default;
					},
					async reloadComponent() {
						await this.loadComponent();
						this.componentKey += 1; // キーを更新して再描画をトリガー
					}					
				},
				template: `<a-box width=0.02 height=0.02 depth=0.02  :color="hcolor" opacity=0.8  grabbable2="distance:.04" ss_grabbase>
					<a-entity position="0 0.01 0" >
						<component :key=key :is=ccompo ${propstr.join(" ")} />
					</a-entity>
				</a-box>`
			})
			const el = document.createElement("a-entity")
			let posy = document.querySelector("[camera]").object3D.position.y	
			if(posy==0) posy=1
			el.setAttribute("position",`${this.posx} ${posy} 0`)
			this.posx += 0.1 
			if(this.posx > 0.3) this.posx -= 0.58

			const appinst = app2.mount(el)
			$('#base').appendChild(el) 
			return {id:param.id,app:appinst,el:el,time:new Date().getTime()}
		}
	}
})

onload = function() {
	$('a-scene').addEventListener("loaded",ev=>{
		console.log("scene loaded")
		window.APP = APP.mount('#reactive') // set global APP reference
		window.APP.bg_kind = 'space' 
	})
}//onload

</script>
<style>
html,body {
	width:100% ;
	height:100% ;
	margin:0 ;
}
#stat {
	position:absolute ;
	width:40rem ;
	height:2rem ;
	background-color:black ;
	color:white ;
	z-index:100;
}
</style>
</head>
<body>

<a-scene  xr-mode-ui="XRMode:xr" device-orientation-permission-ui="enabled: false" background="color:#444")
stat>
	<a-assets>
			<img id="floortex" src="assets/tex1024.png">
			<img id="photo360" src="assets/IMG_20200104_162551_tamako.jpg">
	</a-assets>

<!--reactive objects-->
<a-entity id=reactive>
	<div id=stat>SpatialShell Workspace v001 stat {{stat_calls}}calls {{stat_poly}}△	</div>
	
	<!--app base -->
	<a-entity id=base  position="0 0 -0.3"  scale="1 1 1" rotation="0 0 0">
	</a-entity>
	<!-- background -->
	<a-entity id=background noar>
		<a-entity v-if="bg_kind=='space'" id=bg_space >
			<!--floor-->
			<a-plane  position="0 -0.001 0" rotation="-90 0 0" width="200" height="200" color="#444" :material="`shader:flat;repeat:20 20;src:#floortex;transparent:true;opacity:${bg_mix}`"></a-plane>
			<!--sky-->
			<a-sky  :material="`shader:flat;color:#446;transparent:true;opacity:${bg_mix}`" radius="110" segments-height="6" segments-width="12"></a-sky>
		</a-entity>
	</a-entity>
	
	<!--lights-->
	<a-entity id=light>
		<a-entity light="type: ambient; color: #888"></a-entity>
		<a-entity light="type: directional; color: #FFF; intensity: 0.6; castShadow:false;" position="-0.5 1 1"></a-entity>
	</a-entity>
</a-entity>

	<!--camera-->
	<a-entity id="camrig"  position="0 1.2 0" vrheight > 
		<a-entity id="camera" camera  look-controls="magicWindowTrackingEnabled:false" wasd-controls></a-entity>
		<!--vr controller-->
		<a-entity oculus-touch-controls="hand: left; model:false"  grab2 ></a-entity>
		<a-entity oculus-touch-controls="hand: right; model:true"  grab2 ></a-entity>
		<a-entity id=hand_l hand-tracking-controls="hand: left" grab2="realhand:true"></a-entity>
		<a-entity id=hand_r hand-tracking-controls="hand: right" grab2="realhand:true"></a-entity>
	</a-entity>
</a-scene>

</body>
</html>
